<html lang="en">
  <body>
    <div id="app"></div>
    <script src="./reactivity/index.js"></script>
    <script src="./runtime/h.js"></script>
    <script src="./runtime/renderer.js"></script>
    <script>
      const Vue = {
        createApp(config) {
          return {
            mount: function (container) {
              const dom = document.querySelector(container);
              // 生成渲染函数
              // 获取渲染对象，并且在setup中执行了响应式
              const setupResult = config.setup();

              let isMounted = false;
              // 前自述
              let prevSubTree;
              // 监听副作用函数，产生一个闭包环境
              watchEffect(() => {
                // 没有挂载
                if (!isMounted) {
                  // 清空dom下的所有文本
                  dom.innerHTML = '';
                  // 标记为已挂载
                  isMounted = true;
                  // render函数渲染子树，render过程会访问到设置了响应式的变量，进而进行依赖收集
                  const subTree = config.render(setupResult);
                  // 当前子树赋值给旧子树，用于下次diff对比
                  prevSubTree = subTree;
                  // 执行挂载
                  mountElement(subTree, dom);
                } else {
                  // 因为content.state.message的值已经改变，需要获取最新的渲染子树
                  const subTree = config.render(setupResult);
                  // diff算法对比
                  diff(prevSubTree, subTree);
                  prevSubTree = subTree;
                }
              });
            },
          };
        },
      };
      // 定义响应函数
      let effective;
      const App = {
        // 视图
        // template: `
        //         <input v-model="message"/>
        //         <button @click='click'>{{message}}</button>
        //     `,

        render(content) {
          return h('div', null, [
            h('div', null, String(content.state.message)),
            h(
              'button',
              {
                onClick: content.click,
              },
              'click',
            ),
          ]);
        },

        setup() {
          const state = reactive({
            message: 'Hello Vue 3!!',
          });

          const click = () => {
            state.message = state.message.split('').reverse().join('');
          };
          return { state, click };
        },
      };
      const { createApp } = Vue;
      createApp(App).mount('#app');
    </script>
  </body>
</html>
